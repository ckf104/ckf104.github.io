## The Tera Computer System

Tera 计算机系统是由美国华盛顿州的Tera计算公司（现称为Cray Inc.）开发的一套高性能并行超级计算机系统。伴随日益增长的大规模科学计算和数据处理需求，传统计算机体系结构在并行性和扩展性方面面临很大瓶颈。Tera系统的设计就是为了解决这些瓶颈，使得计算性能能在更多并行任务负荷下得到有效提升

接下来，我将从 Processor，Interconnection，Memory，三个方面介绍 Tera 系统的实现

### Processor

Tera 处理器采用了同时多线程的设计方法，每个处理器支持最多 128 个线程同时运行。在每个周期，处理器都会选择一个线程，执行它的一条指令。每个线程都有它独立的状态和寄存器，这保证了线程切换能够快速进行：一个 64 bits 的 Stream Status Word，它的低 32 bits 表示 pc，高 32 bits 表示线程的一些状态，包括 trap disable mask，floating point rounding mode，conditional code，是否启用 lookahead 等等。32 个 64 bits 的通用寄存器，8 个 64 bits 的目标寄存器（表示分支指令的跳转目标，显式用寄存器表示跳转目标使得分支预测时不再需要预测跳转目标），其中 0 号目标寄存器指向 trap handler，表示发生异常时需要执行的程序

在指令系统的设计上，Tera 处理器采用了 VLIW 范式，每条指令最多包含三条指令：一条访存指令，一条算数指令，一个条件跳转指令或者算数指令或者地址计算指令

为庞大的寄存器堆设计一个计分板来处理冒险会占用大量的资源，因此 Tera 处理器中没有使用任何的冒险检测逻辑，每个线程只能有最多一条指令在处理器中执行。平均而言，每条指令需要执行 70 个周期，因此为充分利用 Tera 处理器的计算资源，需要有至少 70 个线程同时运行。为了减少占满计算资源需要的线程数，Tera 处理器中引用了lookahead 技术。想法也很直接，通常处理器是通过计分板等方法，动态计算指令间的依赖关系。但是指令间的依赖关系是在编译阶段可见的，不如牺牲一些编码位域，将这些依赖关系直接内嵌在指令编码中。Tera 处理器的每条指令有 3 bits 用于描述该指令后面的连续多少条指令与该指令没有依赖关系。这使得每个线程最多能有 8 条指令同时运行在处理器中，占满计算资源需要的线程数大大减小。这一思想也被后续的指令集设计沿用。例如从 Nvidia 的 Kepler 架构后，每条指令都带有 Control Code，用来指示当前指令会阻塞后续指令的 cycle 数，以及重用操作数（Register Reuse Cache）等信息

### Memory

Tera 系统中每个内存单元都包含 128MB 的内存，内存以长为 64 bit 的 word 形式组织，每个 word 包含 4 bits 的状态位和若干 bits 的纠错码。4 bits 的状态位由 2bits trap 位，1 bit 的 forward 位，1 bit 的 full / empty 位构成

Tera 系统的内存地址的高位 bits 是访存的状态位，其中 2 bits 的 trap 位与内存中的 2bits trap 位相对应，如果访存地址中某个 trap 位为 0，而地址对应的内存中的 trap 位为 1，那么会引发异常。这个最直接的应用是实现 hardware data watch points，例如我们在调试时希望我们关心的数据被访问时就触发断点，这个功能就可以通过将数据所在 word 的 trap 位置 1 来实现

forward bit 用于内存数据的间接访问，当访存地址的高位 bits 没有禁止 forward bit，并且地址对应的 word 的 forward bit 为 1 时，该 word 的内容被认为是新的访存地址，最终访存的数据由新的访存地址决定。这个过程会递归地进行，直到访存地址的高位 bits 禁止 forward bit，或者地址对应的 word 的 forward bit 为 0

最后还有一个 full / empty 的标志位，这个标志位可以用来实现原子操作和线程间同步。load / store 指令有两位是用作访存控制。对于 load 指令而言，如果控制位的值为 0，表示普通的 load 指令。而如果控制位的值为 3，则该 load 指令会等待该地址的 full / empty 标志位为 full 时才执行，并在执行完成后将标志位重新设置为 empty。而如果 store 指令的控制位为 3，则 store 指令为等待地址的 full / empty 标志位为 empty 时才执行，并在执行完成后将标志位重新设置为 full。可以看到，这简单提供了一个生产者，消费者的同步原语

### Interconnection

Tera 系统的互联采取了 16x16x16 的三维的网格结构，因此共有 4096 个网格节点，这些网格节点负责数据传输，其中 1280 个交换机节点与其它资源相邻，这包括 256 个 Tera 处理器，512 个内存单元，256 个 IO 缓存单元和 256 个 IO 处理机。为了减少拓扑，奇数层的 Z 方向的平面不连接 X 轴方向的节点，偶数层的 Z 方向平面不连接 Y 轴方向的节点，这使得每个节点的连接数从 6 降为 4

### Summary

Tera计算机系统的革新性设计为后续很多高性能计算（HPC）机型提供了重要参考和启发