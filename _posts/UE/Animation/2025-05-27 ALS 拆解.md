### 走跑混合
参考
* [UE5 骨骼动画 高级运动系统 走跑混合初步](https://zhuanlan.zhihu.com/p/482748722)
* [62 高级运动系统解构 移动步幅与走跑混合](https://www.bilibili.com/video/BV12f4y1r71N/?p=53&spm_id_from=333.851.header_right.history_list.click&vd_source=2f38c661a6672237a3f59835e4bfb1a5)

运动速度和动画不匹配会导致移动时的滑步（**注意和过渡态的滑步进行区分，过渡态的滑步，例如走到停，是由于简单粗暴的插值导致的，虽然也可以理解为速度不匹配就是了**），可以通过动画编辑器中预览的 foot_l 和 foot_r 关节在地面的位移除以相应的时间来估算一个与动画效果相匹配的速度（这种估计方法能合理解释 ALS 中 150 的 walking，350 的 run 速度的来历）

动画的步幅和步频会影响最终的运动速度。步幅可以通过动画的混合权重来调整，步频可以通过播放速度来调整。在 ALS 的实现中，用户的输入决定了当前的运动速度，然后根据运动速度来调整步幅的混合权重以及播放速度，大致的做法是
* 如果当前的运动速度小于动画原生的速度（walking 为 150，run 为 350），缩小步幅（ALS 是通过曲线来刻画速度与步幅的映射关系）
* 如果当前的运动速度大于动画原生的速度，增加播放速度
### 八向移动
我们先看一种 naive 的做法，直接使用 blending space，以摄像机方向和速度方向的夹角来混合使用四个动画，分别是向左（-90度夹角），向右（90度夹角），先前（0度夹角），向后（-180度和180度夹角）。实际这样做发现存在两个问题
* **移动方向经过原点会导致 180 度突变**，例如向左的方向突变到向右的方向。可能的做法是设置 blend space 的 Smoothing Time，来平滑过渡，但这样也不太行，因为这个平滑过渡是 -90 逐渐变化到 90 度，而我们需要的是向左的位姿和向右的位姿的混合
* **混合时会出现问题**：向左走或者向右走的动画都有两种，移动时左脚在前面还是右脚在前面（这里的前面是指面朝着的方向，而不是移动的方向）。设想向前走的动画慢慢变化为向左走的动画，最终是右脚在前，左脚在后（或者说朝着移动方向的话，总是左脚在左边，右脚在右边），但对于向后走的动画则反过来了，它如果慢慢变化为向左走的动画，最终是左脚在前，右脚在后。因此当我们只使用四个动画时，向左走的动画无论是左脚在前，还是右脚在前，都会导致与向前走和向后走的某一个动画混合时出现问题

因此 ALS 的实际处理中使用了六个动画，向左和向右分别有两个动画，用来和向前和向后的动画混合。相应的，有六个状态机，而不是四个状态机，以及状态机之前的迁移规则，也是很自然的
#### Sync Group
在八向移动中使用 sync group 有好处，但也会带来一些问题。通常这类动画会使用左右脚落地时作为 sync marker。如果我要混合 LF 方向和 F 方向的动画，那么 sync group 会带来混合的收益。但是我从向左走的动画切换到向右走的动画时候（LF -> RB），向左走的动画右脚落地时的姿态最贴近的是向右走的动画左脚落地时的姿态，但是 sync group 会将向左走右脚落地的动画和向右走右脚落地的动画进行混合，这会导致明显的滑步

~~ALS 为了隐藏这个问题，使用了两个小 trick，一个是在状态机的 transition rule 的混合时间上，对角的 transition rule（例如 F -> B，LB -> RF）的混合时间都是 0.5 秒，而其它 transition rule 的混合时间为 0.7 或者 0.75 秒，另外是 transition rule 的 blend profile，使用 ChangeDirection，这个 profile 中腿的混合速度是其它骨骼的混合速度的两倍~~

LB -> RF 的 transition 时间以及 ChangeDirection 的 profile 在对角的状态迁移上其实没起到什么作用，因为 LB 和 RF 会输出相同的 pose。这里决定混合速度的关键因素是 Velocity Blend Interp Speed 变量

**另外一个问题是 foot crossing**，设想此时处于 RB 状态且左脚落地，然后玩家按了向前，需要切换的 F 状态，RB 动画的左脚落地混合到 F 动画的左脚落地，就会造成脚步穿插（此时最佳的方案应该是固定左脚，移动右脚才对）
#### 位姿混合
每个状态的 pose 输出根据当前的速度方向进行混合，例如速度如果是左前那么就是向左走的动画和向前走的动画进行混合，混合的权重由速度方向偏左和偏前的程度决定

值得留意的是，向左的状态也会混合向右走的动画（例如 LF 状态会混合 RB 动画）。乍一看这样做好像是没必要的，因为当进入向左走的状态时，就已经表明速度方向是朝左了，此时计算出的混合权重也不会让 LF 状态里混合 RB 动画。但实际上是需要的，因为
* 设想当前是向左走的状态，然后切换为向右走的状态。但由于存在混合时间，因此向左走的状态仍然有权重，即使此时速度已经变为向右了
* ALS 通过 Velocity Blend Interp Speed 变量做了权重的平滑插值

注意 ALS 里通过 Velocity Blend Interp Speed 变量做了权重的平滑插值，也就是说当速度方向向左时，TODO：明天再记录，根源还是在于加速度太大了，动画跟不上

TODO：解释 HipOrientation_Bias 曲线的作用，看看 Bow 模式下的八向移动实现

TODO：自己实现八向移动，跑步版的

TODO：[03 八向移动](https://zhuanlan.zhihu.com/p/638673655) 涉及到了 hip 和 pivot 的解释，pivot 和 locomotion details 状态机有很大关系，需要再看看。另外他也尝试了不做权重的平滑插值，看看他有没有遇到什么问题
### 起步停步
ALS 的处理包括
* 起步和停步时步幅混合
### Foot Locking 和 Foot IK

### 原地转身
**TODO：原地转身时 ALS 中 Foot Lock 曲线也有变化，看看这里 foot lock 是干嘛的**

参考
* [62 高级运动系统解构 原地转身](https://www.bilibili.com/video/BV12f4y1r71N/?p=84&vd_source=2f38c661a6672237a3f59835e4bfb1a5)
* [UE5 骨骼动画 高级运动系统 原地旋转](https://zhuanlan.zhihu.com/p/516031820)

什么时候能原地转身
* 角色是否移动
* 摄像机方向和角色朝向之间的夹角
* 摄像机当前的移动速度
* 角色当前是否正在转身（ALS 里转身是作为 montage 在一个 slot 进行播放的，因此检查这个 slot 是否正在播放即可）

如何控制转身速度
* 通过曲线设置每个时刻需要转身的角度
* 每帧采样出的转身角度需要乘以总体的转身倍率（如果动画曲线设置的总体转身角度为 90 度，但我只需要转 45 度，那就需要将采样出的值除以 2）
* 每帧采样出的转身角度需要乘以播放速度（播放速度越快，我采样的次数就越少）
* 每帧采用出的转身角度需要除以帧率（默认的曲线是假设是以 30 帧的频率采样，如果帧率为 60 帧，就双倍采样了，需要除以 2 修正回来）


[UE5 骨骼动画 高级运动系统 原地旋转](https://zhuanlan.zhihu.com/p/516031820) 额外提到了 pose 混合时会影响曲线值，导致旋转角度不对。不过 ALS 里面是设置的 montage 播完之后才开始混合（此时曲线值已经将为 0 了），所以不会存在这个问题（后续的逻辑是否有混合？）

为什么 ALS 中蹲伏的时候不会缩放旋转角度?

TODO：解释 moving rotation

## 复现
与 ALS 有差异的部分
* ~~StrideBlend 的计算 ALS 是用了一根曲线~~
* BlendSpace 中 Stride 输入， ALS 进行了平滑

