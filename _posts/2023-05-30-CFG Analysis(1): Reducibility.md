---
title: "CFG Analysis(1): Reducibility"
date: 2023-05-30 10:45:31 +800
math: true
categories: [Compiler]
---

这一个系列是记录流图分析相关的笔记。第一篇我们讨论 **Reducibility**

## 1. 定义

我们沿用 [Characterizations of Reducible Flow Graphs](https://dl.acm.org/doi/pdf/10.1145/321832.321835) 中对可规约流图的定义。

* 定义流图：有向图，且存在初始节点，该节点可达所有其他节点

* 定义图节点合并操作： 合并节点 $n_1, n_2 $ 为 $n_1$，将指向 $n_2$ 的边改为指向 $n_1$ ，删除重复边。

* 定义变换 $T_1$：如果流图中存在节点，该节点有边指向自己，则可使用 $T_1$ 消除该边
* 定义变换 $T_2$：如果流图中存在节点 $n_1，n_2$，使得 $n_2$ 的入边仅有边 $(n_1，n2)$，且 $n_2$ 不为初始节点。则可使用 $T_2$ 将节点 $n_1，n_2$ 合并。

* 定义流图的可规约性：流图 $G$ 可规约，当且仅当可通过一系列的 $T_1，T_2$ 变换，使得 $G$ 仅有单个节点。

变换 $T_1，T_2$ 的重要性质是，在流图 $G$ 上应用它们直到不可再应用，应用顺序不改变最终 $G$ 的结构。这直观上很好理解，如果可以对某节点 $n$ 应用 $T_1$ 或者 $T_2$，如果这次没有选择它，而选择了其它节点，对于变换后得到的新的 $G$，仍可以对 $n$ 应用 $T_1$ 或者 $T_2$ 。而对相同的几组节点应用 $T_1$ 或 $T_2$ 的顺序显然是无关紧要的。

流图可规约性的原始定义不方便直接揭示可规约流图的性质，第二节将给出若干等价定义及其证明。在此之前，引入一些概念作为铺垫

* Tree $T(r)$：流图 $T$ 上节点 $r$ 没有入边，其余节点均恰好一条入边，$r$ 称为根节点（这可直接推出，$r$ 为流图的初始节点）
* Spanning Tree of $G$：$T(r)$ 称为 $G$ 的 Spanning Tree，当且仅当 $T(r)$ 是 $G$ 的子图，且节点数与 $G$ 相同，且 $T(r)$ 是 Tree
* DFST of $G$：$T(r)$ 称为 G 的 DFST，若 $T(r)$ 是 $G$ 的 Spanning Tree，且 $T(r)$ 中的边可通过在 $G$ 上进行深度优先搜索得到

对 DFST 的定义额外进行说明，考虑第二节中的图 1，显然 (A->B, B->C,B->D) 这三条边构成了 Spanning Tree，但不是 $G$ 的DFST，因为在 $G$ 上进行深度优先搜索访问的边应该是 (A->B, B->C, C->D) 或者 (A->B, B->D, D->C)。

对于流图 $G$，给定 $G$ 的 DFST $T(r)$，我们可以把 $G$ 中不在 $T$ 上的边分为三类

* 称（A->B）为前向边：如果在 $T$ 上 A 是 B 的祖先节点（即在树 $T$ 上 A 可达 B）
* 称（A->B）为回边：如果在 $T$ 上 B 是 A 的祖先节点
* 称 (A->B)为 为交叉边（原文为 cross arc），如果 A 不可达 B，且 B 不可达 A

交叉边的重要性质在于，如果（A->B）是交叉边，那么在树 $T$ 上的位置，A 一定在 B 的右边（即在该 $T$ 对应的深搜的节点访问顺序中，B 在 A 的前面）。否则 $T$ 不可能是一个 DFST。

另外，将前向边和交叉边加入 DFST $T(r)$ ，它仍然是无环的（可以简单地对节点进行赋值，使得祖先节点的值必定大于子节点的值，且左边节点的值大于右边节点的值，由此发现沿着树的边，前向边或者交叉边走，都会使得节点的值变小，由此知道图中无环）。

## 2. 流图可规约性的等价定义

![](/res/base-cfg.png)

_图 1：不可规约流图_

图 1 给出了不可规约流图的基本结构，图上每条边代表了一条的路径。A 节点表示流图的初始节点，A，B 节点可以相同，其余节点要求互不相同。要求各个路径上节点也相互不能重复（例如 B 到 C 的路径上的节点不能与 B 到 D 的路径上的节点重复）。

**定理 1：一个流图是可规约流图当且仅当该流图中不存在如图 1 所示的结构**

该证明来自 [Flow Graph Reducibility](https://www.cs.tufts.edu/~nr/cs257/archive/jeff-ullman/reducibility.pdf)。使用归纳法论证任何不可规约流图都具有图 1 的结构，对流图的节点个数进行归纳。记节点个数为 $n$，$n=3$ 时枚举所有可能的流图即可。

对于一般的有 $n$ 个节点的图 $G$，不失一般性，可设 $G$ 不可使用 $T_1，T_2$ 变换规约。我们考虑其DFST $T(r)$，考虑 $T$ 的最右序列，该序列的第一个节点是根节点 $r$，第二个节点是 $r$ 的最右子节点（即在深搜顺序中，$r$ 的直接子节点中最晚访问到的）。第三个节点是 $r$ 的最右子节点的最右子节点。。。以此类推。最后一个节点是树的叶节点，不再存在子节点。记该序列为 $(r_1,r_2...r_k)$，其中 $r_1=r$

由序列的定义可知，该序列中所有节点都不存在指向它的交叉边。首先指出 $k \ge 3$，这是因为 $G$ 不可规约，那么 $r_2$ 应至少有两条入边。由于 $r_2$ 不存在交叉边，且 $r_2$ 的直接父节点即为根节点，因此也不存在前向边，因此 $r_2$ 必然存在回边，故 $r_2$ 不是叶节点。

现在我们考虑序列中满足条件的下标最大的节点 $r_d$ ：存在一条回边以 $r_d$ 为源节点。记目标节点为 $r_b$ 。现在考虑 $r_1$ 到 $r_{b-1}$ 。若存在某个节点 $r_a$ ，$1\le a \le b-1$ ，使得存在前向边 $(r_a,r_c)$，且 $b \lt c \le d$ ，则可知 $r_1,r_a,r_b,r_c$ 构成了图 1 的结构（ $r_1$ 对应 A，$r_a$ 对应 B ，$r_b$ 对应 C ，$r_c$ 对应 D）。

如果不存在这个的 $r_a$ ，考虑集合 $S=\{r_b, r_{b+1}...r_d\}$ 中的节点，对于任意一条边 $e = (n_1,n_2)$ ，若 $e$ 的源节点 $n_1$ 不在 $S$ 中，但目标节点 $n_2$ 在 $S$ 中，则有 $n_2=r_b$。这是由以下事实保证的：

*  最右节点不存在指向它的交叉边
* 不存在满足要求的 $r_a$ 节点
* $r_d$ 是最大的存在以它为源的回边的最右节点

由于 $r_d$ 至少有两条入边，这表明 $S$ 中至少有三个节点。现在，考虑 $G$ 在 $S$ 上的导出子图 $G'$，由于 $G$ 不可规约， 且 $S$ 外的节点仅有连向 $r_b$ 的边，可以知道 $G'$ 是一个以 $r_b$ 为初始节点的不可规约流图。对 $G'$ 应用归纳假设，从而知 $G$ 含有图 1 中的流图结构。

现在考虑论证的另一面，需要说明当流图 $G$ 含有图 1 中的流图结构中，它一定不可规约。为说明这一点只需注意到一个简单的事实：变换 $T_1，T_2$ 不会改变流图是否包含图 1 结构。即如果流图包含图 1 结构，则应用 $T_1，T_2$ 后仍包含。而如果流图不包含图 1 结构，则应该变换后仍不包含。现在假设含有图 1 结构的 $G$ 是可规约的，当应用变换使得 $G$ 仅剩 3 个节点时，$G$ 仍包含图 1 结构，而由前面论证的归纳假设的奠基可知，3 个节点的包含图 1 结构的流图是不可规约的，矛盾！因此定理 1 成立。

定理 1 给出了不可规约流图的基本结构，它是论证其它等价定义的基础。

---

**定理 2：对于流图 $G$，任意给定一个 $G$ 的 DFST ，则 $G$ 可规约当且仅当对于 $G$ 的所有回边，它的目的节点支配源节点（这里的支配是在 $G$ 上定义的）** 

假设 $G$ 不可规约，则 $G$ 具有图 1 结构，由于图 1 中 C，D 节点有环，因此该环中必定存在回边。不妨设在 C 到 D 的路径上存在回边（M，N），由于初始节点可以途经 B，C 到达 M，因此 N 节点不支配 M 节点。

反过来考虑 $G$ 中存在回边 $(r_d,r_b)$ ，且 $r_b$ 不支配 $r_d$ ，取 $r_d$ 是具有这样性质的最右节点（即该 DFST 对应的深搜顺序中最靠后的节点）。我们说明 $G$ 具有图 1 结构，从而指出 $G$ 不可规约。

这里的考虑与定理 1 是类似的，假设从根节点沿着树的路径到达 $r_d$ ，一路的节点序列为 $(r_1,r_2...r_b...r_d)$。如果存在节点 $r_k$，且 $1\le k \lt b$，有前向边 $(r_k, r_s)$，其中 $b \lt s \le d$ ，那么节点 $r_1,r_k,r_s,r_b$ 构成了图 1 结构（ $r_k$ 通过树的路径到达 $r_b$ ，通过前向边到达 $r_s$ ，$r_b$ 通过树路径到达 $r_s$ , $r_s$ 先到达 $r_d$ ，再通过回边到达 $r_b$ ）。下面假设不存在这样的 $r_k$ ，由于 $r_d$ 并不被 $r_b$ 支配，因此存在从 $r_1$ 到 $r_d$ 的路径 $P$ ，且 $P$ 不经过 $r_b$ 。考虑路径上最后一个不是 $r_b$ 子孙的节点 $s$ ，以及路径上最后一个不在序列 $(r_{b+1}...r_d)$ 中的节点 $t$ ，则  $t$ 或者与 $s$ 相同，或者在路径 $P$ 上排在 $s$ 的后边。考虑路径 $P$ 上 $t$ 的后继节点 $r_m$ ，$b+1 \le m \le d$ 。首先边 $(t,r_m)$ 必定是交叉边（由 $r_k$ 的不存在排除前向边，由 $r_d$ 的极大性排除回边）。考虑 $r_b$ 和 $s$ 的共同祖先 $r_i$ ，$1 \le i \lt b$ 。现在考虑 $r_1,r_i,r_b,r_m$ 这四个节点。$r_1$沿着树路径到达 $r_i$ ，$r_i$ 通过树路径到达 $s$ ，通过 $P$ 上路径到达 $t$，进一步到达$r_m$（该路径上的节点显然与 $r_1$ 到 $r_i$ 不重复，因为 $s$ 以后到 $r_m$ 的节点都是 $r_b$ 的子孙节点）。同时 $r_i$ 可通过树路径到达 $r_b$ 。$r_b$ 可通过树路径到达 $r_m$，$r_m$先到达 $r_d$ ，再通过回边到达 $r_b$ 。因此 $G$ 具有图 1 结构，从而不可规约。

---

由于流图中回边的定义依赖于 DFST 的选取，而定理 2 告诉我们，判定 $G$ 的可规约性时任取一个 DFST 即可。这自然容易想到，可规约流图 $G$ 的回边是否不依赖于 DFST 的选取？

为说明这个问题，首先定义 $G$ 的 dag ：称流图 $D$ 为 $G$ 的 dag ，若 $D$ 是 $G$ 的子图，它们初始节点相同，且节点数与 $G$ 相同，并且没有环，并且将任意一条 $G$ 中不在 $D$ 的边加入 $D$ 后，$D$ 中将有环。

根据该定义，马上会发现任意给定一个 $G$ 的 DFST，DFST 中的边、前向边、交叉边组成的子图构成了 $G$ 的 dag 。

**定理 3：$G$ 是可规约流图当且仅当 $G$ 的 dag 唯一**

可以看到，如果定理 3 成立，这表明 DFST中的边并上前向边与交叉边得到的边集不依赖于 DFST 的选取，因此它的补集，回边也不依赖于 DFST 的选取。

如果 $G$ 是不可规约流图，那么 $G$ 存在图 1 结构，设路径 C -> D 上最后一条边是 $e_c$ ，路径 D -> C 上最后一条边是 $e_d$ ，我们考虑两种可能的深搜顺序，一种是从 A -> B -> C -> D -> C ，这样一种顺序得到的 DFST 中，$e_d$ 是回边，$e_c$ 是树边。另一种顺序是 A -> B -> D -> C -> D ，对应的 DFST 中 $e_d$ 是树边，$e_c$ 是回边。因此两个 DFST 对应的 $G$ 的 dag 是不一样的。

现在假设 $G$ 存在两个不同的 dag ：$D_1$ ，$D_2$ 。不是一般性，可设 $D_1$ 是由某个 DFST 加入前向边和交叉边得到的。考虑任意一条边 $e \notin D_1 ，e \in D_2$ ，并设边 $e$ 的源节点和目标节点分别为 $m，n$ 。由于 $D_2$ 是流图，因此存在初始节点到 $m$ 的路径，又由于 $D_2$ 无环，因此该路径不经过 $n$，这表明 $n$ 在 $G$ 上不支配 $m$ ，但 $e$ 在 $D_1$ 对应的 DFST 中是回边，由定理 2 知 $G$ 不可规约。

---

**定理 4：$G$ 是可规约流图当且仅当存在 $G$ 的 dag $D$ ，对于 $G$ 里不在 $D$ 中的边都有目的节点支配源节点（支配关系在 $G$ 上定义的）**

事实上，更强的结论，等价与在 $D$ 上有目的节点支配源节点，也是成立的，但我们略去它的证明，详细的证明在 [Characterizations of Reducible Flow Graphs](https://dl.acm.org/doi/pdf/10.1145/321832.321835) 中。

当 $G$ 可规约时，任取一个 DFST 对应的 dag 即可满足要求。而若 $G$ 不可规约，$G$ 存在 图 1 的结构，如果此时满足要求的 $D$ 存在，由于 C 和 D 的路径构成环，必有一条边 $e$ 不在 $D$ 中，不妨设 $e$ 在路径 C -> D 中。那么可从 A -> B -> C -> $e$ 的源节点的方式，在不经过 $e$ 的目标节点的情况下到达源节点。这与 D 满足要求矛盾。

---

**定理 5：$G$ 是可规约流图当且仅当对 $G$ 中任意一个环，都存在环上一个节点，它支配环上其它所有节点**

当 $G$ 不可规约时，考虑图 1 结构中 C，D 构成的环，显然不存在一个节点同时支配 C，D。当 $G$ 可规约时，考虑任意一个环 $C$，则 $C$ 中必存在回边，假设回边的目的节点是 $m$，源节点是 $n$。则 $m$ 支配 $n$，现在考虑 $C$ 中任意一个节点 $k$ ，如果 $m$ 不支配 $k$ ，那么存在路径从初始节点不经过 $m$ 到达 $k$ ，进一步沿着 $C$ 上的边到达 $n$ ，与 $m$ 支配 $n$ 矛盾！

通过以上给出的一系列的等价定义，我想这下对可规约性的理解就差不多了。其中最重要的是定理 2，3。它们表明可规约流图回边定义不依赖于 DFST 的选取。在下一篇的分析中会看到，可规约流图中每一条回边都定义了一个自然循环。

## 3. 流图规约性的判定算法

本节阐述 Tarjan 的流图规约性判定算法。首先给出一些基本结论

定理 6：通过深度优先搜索，可以按到达顺序给节点从 1 开始依次编号，在该搜索对应的 DFST $T(r)$ 上，编号为 $n$ 的节点可达编号为 $k$ 的节点当且仅当 $n \le k \le n+t$ ，其中 $t$ 是编号为 $n$ 的节点的子孙数量。

定理 7：给定 流图 $G$ 和它的 DFST $T(r)$ ，对每个节点 $w$，定义 $P(w)=\{\exist v，v在不经过w的情况下可达u，且(u,w)是回边\}$。那么 $G$ 可规约当且仅当对任意 $w，v \in P(w)$ ，有 $w$ 在 $T$ 上是 $v$ 的祖先节点。

定理 6 是显然的，简单地说明一下定理 7 的正确性。如果 $G$ 可规约，可导出对任意 $v \in P(w)$ ，有 $w$ 支配 $v$ ，进一步导出 $w$ 是 $v$ 的祖先节点。另一方面，若 $w$ 是任意 $v \in P(w)$ 的祖先，可导出 $w$ 支配 $v$ ，从而说明 $G$ 可规约。

有了定理 7 后，一种简单的算法是，求出每个节点 $w$ 的 $P(w)$ ，通过定理 6 在 O(1) 时间内验证两个节点的可达性。但是计算每个节点的 $P(w)$ 导致许多边都需要重复遍历，效率底下。Tarjan 算法的重要发现是，为某个节点求出 $P(w)$ 后，如果 $w$ 可达$P(w)$ 中所有节点，那么可以将 $P(w)$ 中所有节点合并到 $w$ 节点上，不改变图的可规约性。

定理 8：给定流图 $G$ 和它的 DFST $T(r)$ ，并将流图中的节点按深搜顺序从 1 开始逐一编号，考虑 $G$ 中编号最大的节点 $w$ ，使得存在以 $w$ 为目的节点的回边。如果 $w$ 是 $P(w)$ 中所有节点的祖先节点，那么可以将 $P(w)$ 中的节点都合并到 $w$ 中，此时 $G$ 变为 $G'$ ，$T$ 变为 $T'$。则有 $T'$ 是 $G'$ 的 DFST，在$G'$ 中保留节点本来的编号时（而不重新依次编号），定理 6 仍然成立（当然定理 6 中的 $t$ 值也不修改）。且 $G$ 可规约当且仅当 $G'$ 可规约，$G$ 中的前向边，交叉边，回边在 $G'$ 中仍为前向边，交叉边，回边。

定理 8 的论述有点长。抓住核心来讲，它想说的是，之前阐述的简单判断流图回边的算法可以进行优化：首先不是求出每个节点的 $P(w)$，应该按编号顺序从大到小考虑。对于最大的有回边以其为目的节点的 $w$，通过广搜求出其 $P(w)$，然后检查 $w$ 是否为 $P(w)$ 所有节点的祖先。如果不是，则流图 $G$ 不可规约。否则将 $P(w)$ 中的节点都合并到 $w$ 中，得到新的流图 $G'$，而定理 8 告诉我们，$G'$ 的可规约性与 $G$ 相同。同时流图的结构完全不变，因此不需要再重新给 $G'$ 中的节点编号，也不需要重新计算回边等等。

在算法实际运行时，并不需要真的去合并这些节点并计算 $G'$ 的边，利用并查集即可，每次合并时，将顶点所在集合合并起来即可。因此实际的算法如下

```
首先进行深搜，为每个节点编号并确定所有回边
FOR w = V to 1:  # V 是顶点数目
	对节点 w 进行广搜计算 P(w)，广搜的初始节点是以w为目的节点的回边的源节点。
	从广搜集合中剔除节点 s 时，只需将以 s 为目的节点的树边，交叉边，前向边的源节点加入广搜集合即可
	不需要考虑回边，因为由 w 的最大性，回边此时已经被合并了
	将新节点加入广搜集合前，使用并查集的 FIND 函数找出该节点所在的集合的头结点，实际加入集合的应该是该头结点
	得到 P(w) 后，使用定理 6 判断 w 是否为 P(w) 中节点的祖先，如果不是，G 则不可规约
	否则使用并查集的 UNION 函数合并 P(w) 中的节点到 w
	continue
控制流正常退出表示 G 可规约
```

分析可以发现，上面的算法每条边至多访问一次。因此复杂度为$O(V*union(V)+E*find(V))$

## Refs

主要参考了以下的一些论文

* [Flow Graph Reducibility](https://www.cs.tufts.edu/~nr/cs257/archive/jeff-ullman/reducibility.pdf)
* [Characterizations of Reducible Flow Graphs](https://dl.acm.org/doi/pdf/10.1145/321832.321835)
* [Testing Flow Graph Reducibility](https://core.ac.uk/download/pdf/82032035.pdf)



